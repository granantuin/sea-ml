
# Airport Machine Learning Models

This repository provides machine learning models and tools designed to predict meteorological variables as reported in METARs. The repository includes two types of algorithms: those based on the scikit-learn library (deployed via airport_ml.py) and algorithms leveraging large language models (LLMs), which are deployed using mlmetar_forecast.py. The models are trained on meteorological data specific to each airport, identified by its ICAO code.

## Repository Structure

```bash
.
├── README.md                 # Project documentation (this file)
├── airport_ml.py             # Script for running ML models based on the scikit-learn library
├── help_functions.py         # Helper functions used across different scripts
├── mlmetar_forecast.py       # Script for METAR forecasting leveraging large language models (LLMs)
├── requirements.txt          # Python packages and dependencies required
├── ICAO-code/                # Files and models related to ICAO code airport            
│   └── input_files/          # Input data files for training models for ICAO code airport
│   └── notebooks/            # Jupyter notebooks for training and testing models for ICAO code airport
    └── algorithms/           # Pre-trained model files (.al) for ICAO code airport 
```

## Usage

### Input Files

1. **`get_metar_<ICAO-code>.ipynb`**: Jupyter Notebook used to retrieve METAR reports from the Iowa State University database for a specified airport, identified by its ICAO code (e.g., LEST, LECO).

2. `<ICAO-code>Y2018Y2022.csv:` A CSV file containing meteorological variables observed in METAR reports for the specified ICAO code, covering the years 2018 to 2022. This file is generated as an output from the `get_metar_<ICAO-code>`.ipynb notebook.

3. **get_wrf_4k.ipynb**: Jupyter Notebook designed to retrieve historical meteorological data from WRF (Weather Research and Forecasting) models provided by MeteoGalicia. This data is used for model training and analysis.

4. distan_lat(a)_lon(b)_p(c)_R(d)Km.csv: A CSV file listing the coordinates of the c nearest WRF model grid points to a given airport, specified by its latitude (a) and longitude (b). The file also includes the distance (d) in kilometers between each model grid point and the airport. This file is generated by the get_wrf_4k.ipynb notebook.

5. lat(a)_lon(b)_p(c)_R(d)Km.kml: A KML (Keyhole Markup Language) file containing the geospatial data from the CSV file described above. It maps the WRF model grid points around the airport for easy visualization in GIS tools like Google Earth. This file is also an output from the get_wrf_4k.ipynb notebook.

6. lat(a)_lon(b)_p(c)_R(d)Km_D(e)_Y(f).csv: A CSV file containing forecasted meteorological variables from the WRF model, with a forecast range of Day (e) for the year Y(f). The variables are organized by proximity to the airport: variables with subindex 0 correspond to the nearest grid point to the airport’s coordinates (a, b), and subsequent subindices represent increasingly distant grid points. The distance between forecasted points is denoted by (d). This file is produced by the get_wrf_4k.ipynb notebook.

### Notebooks

This repository includes two types of notebooks: those for training and saving algorithms for individual meteorological variables, and those associated with LLMs (Language Learning Models) to forecast the entire METAR report.

#### Meteorological Variable Models

The models for individual meteorological variables are trained using Jupyter notebooks located in the respective airport directories (e.g., `LEST/notebooks/`). Each notebook is specific to an airport and contains the steps for training and evaluating machine learning models. The files follow the naming convention `variable_code_<ICAO_code>_d<x>`. Occasionally, filenames include a forecast range, such as `d0`, `d1`, etc., indicating the scope of the algorithm trained (e.g., `d0` for forecasts from H00 to H24, `d1` for forecasts from H24 to H48).

**Variable Code List:**

| Variable Code | Meaning                                  |
| ------------- | ---------------------------------------- |
| **dir**       | Wind direction                           |
| **spd**       | Wind speed                               |
| **vis**       | Visibility                               |
| **prec**      | Precipitation                            |
| **llwx**      | Present weather (used in LLM)            |
| **BRFG**      | Fog occurrence                           |
| **llmskyc1**  | First cloud cover (used in LLM)          |
| **llmskyl1**  | First cloud height (used in LLM)         |
| **llmskyc2**  | Second cloud cover (used in LLM)         |
| **temp**      | Temperature                              |
| **llmtempd**  | Dew point temperature (used in LLM)      |
| **pres**      | QNH (Atmospheric pressure at sea level)  |

**To train a model:**

1. Navigate to the notebook directory for the desired airport (e.g., `LEST/notebooks/`).
2. Open the desired notebook in Jupyter Notebook or Jupyter Lab.
3. Follow the steps in the notebook to preprocess the data, train the model, and save the trained model to the `algorithms/` directory.

#### LLM-Based METAR Forecasting

The second type of notebooks are related to using LLMs to forecast entire METAR reports. These notebooks follow a structured process:

1. **`<ICAO-code>fusion_ml.ipynb`:**
   - This notebook creates an array of strings with meteorological variables forecasted by algorithms followed by the actual METAR report.
   - **Output file:** `<ICAO-code>fusionml.csv`.

2. **`<ICAO-code>trainml.ipynb`:**
   - Trains a Keras model using the data from `<ICAO-code>fusionml.csv`.
   - **Outputs:**
     1. Trained Keras model saved as `<ICAO-code>/algorithms/<ICAO-code>_ml.keras`.
     2. Test data file saved as `<ICAO-code>/notebooks/<ICAO-code>texts_testml.csv`.
     3. JSON tokenizer file containing all words from the training data, saved as `<ICAO-code>/algorithms/<ICAO-code>_tokenizerml.json`.

3. **`<ICAO-code>mlcheck.ipynb`:**
   - Tests the trained Keras model using the files `<ICAO-code>texts_testml.csv` and `<ICAO-code>_tokenizerml.json`.
   - **Output file:** `<ICAO-code>_resultml.csv`.


### Algorithm Files

1. **`<ICAO-code>coor.csv:`** A CSV file listing the coordinates of the nearest WRF model grid points to a given airport. This is the input file used to obtain the forecast for the points closest to the airport.
2. **`<ICAO-code>_ml.keras:`** The trained Keras model file.
3. **`<ICAO-code>_tokenizerml.json:`** A JSON file containing the tokens/words from METAR reports and the forecasted meteorological variables.
4. **`<ICAO-code>_mlscore.csv:`** A CSV file containing the performance scores of the machine learning models and the LLM.
5. **`variable_code_<ICAO-code>_d<x>.al:`** A Pickle file containing a dictionary with the nearest coordinates to the airport, the machine learning pipeline, and the model score. The `variable_code` corresponds to the codes from the table above, and `<x>` indicates the forecast range (e.g., `d0`, `d1`).


### Dependencies

The required Python packages and dependencies are listed in the `requirements.txt` file. To install them, run:

```bash
pip install -r requirements.txt
```

### Deploying the Model

1. To deploy the model that predicts meteorological variables as reported in METARs using algorithms based on the scikit-learn library, visit the following [Streamlit app](https://airport-ml.streamlit.app/).
2. To deploy the LLM model that forecasts the entire METAR report, visit this [Streamlit app](https://llmmetarforecast-ml.streamlit.app/).



